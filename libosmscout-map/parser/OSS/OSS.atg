#include <iostream>
#include <limits>
#include <list>
#include <sstream>

#include <osmscout/TypeConfig.h>

#include <osmscout/util/String.h>
#include <osmscout/util/Transformation.h>

COMPILER OSS

typedef std::list<FillStyleRef>     FillStyleList;
typedef std::list<IconStyleRef>     IconStyleList;
typedef std::list<TextStyleRef>     TextStyleList;
typedef std::list<LineStyleRef>     LineStyleList;
typedef std::list<PathTextStyleRef> PathTextStyleList;
typedef std::list<ShieldStyleRef>   ShieldStyleList;

inline std::string Destring(const char* str)
{
  std::string result(str);

  if (result.length()>=2 &&
      result[0]=='"' &&
      result[result.length()-1]=='"') {
    result=result.substr(1,result.length()-2);
  }

  return result;
}

inline bool StringToDouble(const char* string, double& value)
{
  std::istringstream buffer(string);

  buffer.imbue(std::locale::classic());

  buffer >> value;

  return !buffer.fail() && !buffer.bad() && buffer.eof();
}

inline size_t GetHexDigitValue(char c)
{
  if (c>='0' && c<='9') {
    return c-'0';
  }
  else if (c>='a' && c<='f') {
    return 10+(c-'a');
  }

  assert(false);
}

inline void ToRGBA(const char* str, Color& color)
{
  double r=(16*GetHexDigitValue(str[1])+GetHexDigitValue(str[2]))/255.0;
  double g=(16*GetHexDigitValue(str[3])+GetHexDigitValue(str[4]))/255.0;
  double b=(16*GetHexDigitValue(str[5])+GetHexDigitValue(str[6]))/255.0;
  double a;

  if (strlen(str)==9) {
    a=(16*GetHexDigitValue(str[7])+GetHexDigitValue(str[8]))/255.0;
  }
  else {
    a=1.0;
  }

  color=Color(r,g,b,a);
}

CHARACTERS
  letter     = 'a'..'z' + 'A'..'Z'.
  digit      = '0'..'9'.
  hexdigit   = 'a'..'f' + '0'..'9'.
  eol        = '\n'.
  stringchar = ANY - '"'.
  quotchar   = ANY.

TOKENS
  ident      = ('_' | letter) {letter | digit | '_'}.
  number     = ['-'] digit {digit}.
  double     = ['-'] digit {digit} '.' digit {digit}.
  color      = "#" hexdigit hexdigit hexdigit hexdigit hexdigit hexdigit [hexdigit hexdigit].
  string     = '"' {stringchar | '\\' quotchar} '"'.

COMMENTS FROM "/*" TO "*/" NESTED
COMMENTS FROM "//" TO eol

IGNORE ' ' + '\t' + '\r' + '\n'

PRODUCTIONS
  OSS         = SYNC "OSS"
                [
                  WAYORDER
                ]
                {
                  SYMBOL
                }
                {
                  (. StyleFilter filter; .)
                  STYLE<filter>
                }
                "END"
                (.
                /*
              	  for (TypeId type=0; type<=config.GetTypeConfig()->GetMaxTypeId(); type++) {
              	    if (config.GetTypeConfig()->GetTypeInfo(type).CanBeWay()) {
	              	  if (config.GetWayPrio(type)==std::numeric_limits<size_t>::max() &&
	              	      config.GetWayLineStyle(type)!=NULL) {
	                    std::string e="Way type '"+config.GetTypeConfig()->GetTypeInfo(type).GetName()+"' has style but is not in a group";
	                    SemWarning(e.c_str());
	              	  }
		              else if (config.GetWayPrio(type)!=std::numeric_limits<size_t>::max() &&
		                       config.GetWayLineStyle(type)==NULL) {
	                    std::string e="Way type '"+config.GetTypeConfig()->GetTypeInfo(type).GetName()+"' is in group but has no style";
	                    SemWarning(e.c_str());
	              	  }
              	    }
              	  }*/
                .)
                .

  WAYORDER    = "ORDER" "WAYS"
                (. size_t priority=1;.)
                {
                  WAYGROUP<priority>
                  (. priority++;.)
                }
                .

  WAYGROUP<size_t priority>
              = "GROUP"
                [
                  (.
                     std::string wayTypeName;
                     TypeId      wayType;
                  .)
                  IDENT<wayTypeName>
                  (.
      	              wayType=config.GetTypeConfig()->GetWayTypeId(wayTypeName);

                      if (wayType==typeIgnore) {
                        std::string e="Unknown way type '"+wayTypeName+"'";
                        SemErr(e.c_str());
                      }
                      else {
                        config.SetWayPrio(wayType,priority);
                      }
                  .)
                ]
                {
                  (.
                     std::string wayTypeName;
                     TypeId      wayType;
                  .)
                  ","
                  IDENT<wayTypeName>
                  (.
      	              wayType=config.GetTypeConfig()->GetWayTypeId(wayTypeName);

                      if (wayType==typeIgnore) {
                        std::string e="Unknown way type '"+wayTypeName+"'";
  	                    SemErr(e.c_str());
                      }
                      else {
                        config.SetWayPrio(wayType,priority);
                      }
                  .)
                }
                .

  SYMBOL      = "SYMBOL"
                (.
                  std::string name;
                .)
                IDENT<name>
                (.
                  SymbolRef   symbol=new Symbol(name);
                .)
                {
                  POLYGON<*symbol>
                | RECTANGLE<*symbol>
                | CIRCLE<*symbol>
                }
                (.
                  if (!config.RegisterSymbol(symbol)) {
                    std::string e="Map symbol '"+symbol->GetName()+"' is already defined";
                    SemErr(e.c_str());
                  }
                .)
                .

  POLYGON<Symbol& symbol>
              = "POLYGON"
                (.
                  StyleFilter         filter;
                  FillStyleSelector   selector(filter);

                  selector.style=new FillStyle();

                  PolygonPrimitiveRef polygon(new PolygonPrimitive(selector.style));
                  Pixel               pixel;
                .)
                PIXEL<pixel>   (. polygon->AddPixel(pixel); .)
                PIXEL<pixel>   (. polygon->AddPixel(pixel); .)
                {
                  PIXEL<pixel> (. polygon->AddPixel(pixel); .)
                }
                SYNC "{"
                {
                  FILLDEF<selector> WEAK ";"
                }
                SYNC "}"
                (. symbol.AddPrimitive(polygon); .)
                .

  RECTANGLE<Symbol& symbol>
              = "RECTANGLE"
                (.
                  StyleFilter       filter;
                  FillStyleSelector selector(filter);
                  Pixel             topLeft;
                  double            width;
                  double            height;

                  selector.style=new FillStyle();
                .)
                PIXEL<topLeft>
                DOUBLE<width>
                "x"
                DOUBLE<height>

                SYNC "{"
                {
                  FILLDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  symbol.AddPrimitive(new RectanglePrimitive(topLeft,
                                                             width,height,
                                                             selector.style));
                .)
                .

  CIRCLE<Symbol& symbol>
              = "CIRCLE"
                (.
                  Pixel             center;
                  double            radius;
                  StyleFilter       filter;
                  FillStyleSelector selector(filter);

                  selector.style=new FillStyle();
                .)
                PIXEL<center>
                DOUBLE<radius>
                SYNC "{"
                {
                  FILLDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  symbol.AddPrimitive(new CirclePrimitive(center,
                                                          radius,
                                                          selector.style));
                .)
                .

  PIXEL<Pixel& pixel>
              = (.
                   double x;
                   double y;
                .)
                DOUBLE<x> "," DOUBLE<y>
                (. pixel=Pixel(x,y); .)
                .

  STYLE<StyleFilter filter>
              = [
                  STYLEFILTER<filter>
                ]
                (
                  (
                    "{"
                    {
                      STYLE<filter>
                    }
                    "}"
                  )
                  | STYLEDEF<filter>
                )
                .

  STYLEFILTER<StyleFilter& filter>
              = "["
                   [
                     (.
                       TypeSet     types;
                       std::string name;
                     .)

                     "TYPE"
                     IDENT<name>
                     (.
                       TypeId type=config.GetTypeConfig()->GetTypeId(name);

                       if (type==typeIgnore) {
                         std::string e="Unknown type '"+name+"'";

                         SemErr(e.c_str());
                       }
                       else if (filter.HasTypes() &&
                                !filter.HasType(type)) {
                         std::string e="Type '"+name+"' is not included by parent filter";

                         SemErr(e.c_str());
                       }
                       else {
                         types.SetType(type);
                       }
                     .)
                     {
                       (. std::string name; .)
                       ","
                       IDENT<name>
                       (.
                         TypeId      type=config.GetTypeConfig()->GetTypeId(name);

                         if (type==typeIgnore) {
                           std::string e="Unknown type '"+name+"'";

                           SemErr(e.c_str());
                         }
                         else if (filter.HasTypes() &&
                                  !filter.HasType(type)) {
                           std::string e="Type '"+name+"' is not included by parent filter";

                           SemErr(e.c_str());
                         }
                         else {
                           types.SetType(type);
                         }
                       .)
                     }

                     (. filter.SetTypes(types); .)
                   ]
                   [
                     "MAG"
                     [
                       (. Mag mag; .)
                       MAG<mag>
                       (.
                          size_t level=MagToLevel(mag);

                          if (level<filter.GetMinLevel()) {
                           std::string e="The magnification interval start is not within the parent magnification range";

                           SemErr(e.c_str());
                          }
                          else {
                            filter.SetMinLevel(level);
                          }
                       .)
                     ]
                     "-"
                     [
                       (. Mag mag; .)
                       MAG<mag>
                       (.
                          size_t level=MagToLevel(mag);

                          if (level>filter.GetMaxLevel()) {
                           std::string e="The magnification interval end is not within the parent magnification range";

                           SemErr(e.c_str());
                          }
                          else {
                            filter.SetMaxLevel(level);
                          }
                       .)
                     ]
                   ]
                   [
                     "ONEWAY"
                     (.
                       filter.SetOneway(true);
                     .)
                   ]
                "]"
                .

  STYLEDEF<StyleFilter filter>
              =   NODESTYLEDEF<filter>
                | WAYSTYLEDEF<filter>
                | AREASTYLEDEF<filter>
                .

  NODESTYLEDEF<StyleFilter filter>
              = SYNC "NODE" "."
                (
                  NODETEXTSTYLE<filter>
                | NODEICONSTYLE<filter>
                )
                .

  NODETEXTSTYLE<StyleFilter filter>
              = SYNC "TEXT"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  TextStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  TEXTDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetNodeTextSelector(filter,selector);
                .)
                .

  NODEICONSTYLE<StyleFilter filter>
              = SYNC "ICON"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  IconStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  ICONDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetNodeIconSelector(filter,selector);
                .)
                .

  WAYSTYLEDEF<StyleFilter filter>
              = SYNC "WAY"
                (
                  WAYSTYLE<filter>
                | "."
                  (
                     WAYPATHTEXTSTYLE<filter>
                  |  WAYPATHSYMBOLSTYLE<filter>
                  |  WAYSHIELDSTYLE<filter>
                  )
                )
                .

  WAYSTYLE<StyleFilter filter>
              = [
                  STYLEFILTER<filter>
                ]
                (.
                  LineStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                   LINEDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetWayLineSelector(filter,selector);
                .)
                .

  WAYPATHTEXTSTYLE<StyleFilter filter>
              = SYNC "TEXT"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  PathTextStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  PATHTEXTDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetWayPathTextSelector(filter,selector);
                .)
                .

  WAYPATHSYMBOLSTYLE<StyleFilter filter>
              = SYNC "SYMBOL"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  PathSymbolStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  PATHSYMBOLDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetWayPathSymbolSelector(filter,selector);
                .)
                .

  WAYSHIELDSTYLE<StyleFilter filter>
              = SYNC "SHIELD"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  ShieldStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  SHIELDDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetWayShieldSelector(filter,selector);
                .)
                .

  AREASTYLEDEF<StyleFilter filter>
              = SYNC "AREA"
                (
                  AREASTYLE<filter>
                | "."
                  (
                    AREATEXTSTYLE<filter>
                  | AREAICONSTYLE<filter>
                  )
                )
                .

  AREASTYLE<StyleFilter filter>
              = [
                  STYLEFILTER<filter>
                ]

                (.
                  FillStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  FILLDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetAreaFillSelector(filter,selector);
                .)
                .

  AREATEXTSTYLE<StyleFilter filter>
              = SYNC "TEXT"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  TextStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  TEXTDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetAreaTextSelector(filter,selector);
                .)
                .

  AREAICONSTYLE<StyleFilter filter>
              = SYNC "ICON"
                [
                  STYLEFILTER<filter>
                ]
                (.
                  IconStyleSelector selector(filter);
                .)
                SYNC "{"
                {
                  ICONDEF<selector> WEAK ";"
                }
                SYNC "}"
                (.
                  config.SetAreaIconSelector(filter,selector);
                .)
                .


  LINEDEF<LineStyleSelector& selector>
              = (
                  (. Color lineColor; .)
                  "color" ":" COLOR<lineColor>
                  (.
                  	 selector.style->SetLineColor(lineColor);
                     selector.attributes.insert(LineStyle::attrLineColor);
                  .)
                | (. Color alternateColor; .)
                  "altColor" ":" COLOR<alternateColor>               // OBSOLETE!
                  (.
                  	 selector.style->SetAlternateColor(alternateColor);
                     selector.attributes.insert(LineStyle::attrAlternateColor);
                  .)
                | (. Color outlineColor;.)
                  "outlineColor" ":" COLOR<outlineColor>
                  (.
                  	 selector.style->SetOutlineColor(outlineColor);
                     selector.attributes.insert(LineStyle::attrOutlineColor);
                  .)
                | (.
                    std::vector<double> dashes;
                    double              dash;
                   .)
                  "dash" ":"
                   DOUBLE<dash>   (. dashes.push_back(dash); .)
                  {
                    ","
                    DOUBLE<dash>  (. dashes.push_back(dash); .)
                  }
                  (.
                  	 selector.style->SetDashes(dashes);
                     selector.attributes.insert(LineStyle::attrDashes);
                  .)
                | (. Color gapColor; .)
                  "gapColor" ":" COLOR<gapColor>
                  (.
                  	 selector.style->SetGapColor(gapColor);
                     selector.attributes.insert(LineStyle::attrGapColor);
                  .)
                | (. double displayWidth; .)
                  "displayWidth" ":"  DISPLAYSIZE<displayWidth>
                  (.
                  	 selector.style->SetDisplayWidth(displayWidth);
                     selector.attributes.insert(LineStyle::attrDisplayWidth);
                  .)
                | (. double width; .)
                  "width" ":" MAPSIZE<width>
                  (.
                  	 selector.style->SetWidth(width);
                     selector.attributes.insert(LineStyle::attrWidth);
                  .)
/*
                | (. bool fixedWidth; .)
                  "fixedWidth" ":" BOOL<fixedWidth>
                  (.
                  	 selector.style->SetFixedWidth(fixedWidth);
                     selector.attributes.insert(LineStyle::attrFixedWidth);
                  .)*/
                | (. LineStyle::CapStyle capStyle; .)
                  "cap" ":" CAPSTYLE<capStyle>
                  (.
                  	 selector.style->SetCapStyle(capStyle);
                     selector.attributes.insert(LineStyle::attrCapStyle);
                  .)
                | (. double outline; .)
                  "outline" ":" DISPLAYSIZE<outline>
                  (.
                  	 selector.style->SetOutline(outline);
                     selector.attributes.insert(LineStyle::attrOutline);
                  .)
                )
                .

  FILLDEF<FillStyleSelector& selector>
              = (
                  (. Color fillColor; .)
                  "color" ":" COLOR<fillColor>
                  (.
                  	 selector.style->SetFillColor(fillColor);
                     selector.attributes.insert(FillStyle::attrFillColor);
                  .)
                | (. std::string patternName; .)
                  "pattern" ":" STRING<patternName>
                  (.
                  	 selector.style->SetPattern(patternName);
                     selector.attributes.insert(FillStyle::attrPattern);
                  .)
                | (. Mag minMag; .)
                  "patternMinMag" ":" MAG<minMag>
                  (.
                  	 selector.style->SetPatternMinMag(minMag);
                     selector.attributes.insert(FillStyle::attrPatternMinMag);
                  .)
                | (. Color borderColor; .)
                  "borderColor" ":" COLOR<borderColor>
                  (.
                  	 selector.style->SetBorderColor(borderColor);
                     selector.attributes.insert(FillStyle::attrBorderColor);
                  .)
                | (. double width; .)
	              "borderWidth" ":" DISPLAYSIZE<width>
                  (.
                  	 selector.style->SetBorderWidth(width);
                     selector.attributes.insert(FillStyle::attrBorderWidth);
                  .)
                | (.
                    std::vector<double> dashes;
                    double              dash;
                   .)
                  "borderDash" ":"
                   DOUBLE<dash>   (. dashes.push_back(dash); .)
                  {
                    ","
                    DOUBLE<dash>  (. dashes.push_back(dash); .)
                  }
                  (.
                  	 selector.style->SetBorderDashes(dashes);
                     selector.attributes.insert(FillStyle::attrBorderDashes);
                  .)
                )
                .

  TEXTDEF<TextStyleSelector& selector>
              = (
                  (. TextStyle::Label label; .)
                  "label" ":" TEXTLABEL<label>
                  (.
                     selector.style->SetLabel(label);
                     selector.attributes.insert(TextStyle::attrLabel);
                  .)
                | (. TextStyle::Style labelStyle; .)
                  "style" ":" LABELSTYLE<labelStyle>
                  (.
                     selector.style->SetStyle(labelStyle);
                     selector.attributes.insert(TextStyle::attrStyle);
                  .)
                | (. Color textColor; .)
                  "color" ":" COLOR<textColor>
                  (.
                     selector.style->SetTextColor(textColor);
                     selector.attributes.insert(TextStyle::attrTextColor);
                  .)
                | (. double size; .)
                  "size" ":" DOUBLE<size>
                  (.
                     selector.style->SetSize(size);
                     selector.attributes.insert(TextStyle::attrSize);
                  .)
                | (. Mag scaleMag; .)
                  "scaleMag" ":" MAG<scaleMag>
                  (.
                     selector.style->SetScaleAndFadeMag(scaleMag);
                     selector.attributes.insert(TextStyle::attrScaleAndFadeMag);
                  .)
                | (. size_t priority; .)
                  "priority" ":" INTEGER<priority>
	              (.
	                if (priority>=0 && priority<std::numeric_limits<uint8_t>::max()) {
                     selector.style->SetPriority((uint8_t)priority);
                     selector.attributes.insert(TextStyle::attrPriority);
	                }
	                else {
	                  std::string e="Priority must be in the interval [0,"+
	                                NumberToString(std::numeric_limits<uint8_t>::max())+"[";

	                  SemErr(e.c_str());
	                }
	               .)
                )
                .

  SHIELDDEF<ShieldStyleSelector& selector>
              = (
                  (. ShieldStyle::Label label; .)
                  "label" ":" SHIELDLABEL<label>
                  (.
                     selector.style->SetLabel(label);
                     selector.attributes.insert(ShieldStyle::attrLabel);
                  .)
                | (. Color textColor; .)
                  "color" ":" COLOR<textColor>
                  (.
                     selector.style->SetTextColor(textColor);
                     selector.attributes.insert(ShieldStyle::attrTextColor);
                  .)
                | (. Color bgColor; .)
                  "backgroundColor" ":" COLOR<bgColor>
                  (.
                     selector.style->SetBgColor(bgColor);
                     selector.attributes.insert(ShieldStyle::attrBgColor);
                  .)
                | (. Color borderColor; .)
	              "borderColor" ":" COLOR<borderColor>
                  (.
                     selector.style->SetBorderColor(borderColor);
                     selector.attributes.insert(ShieldStyle::attrBorderColor);
                  .)
                | (. double size; .)
                  "size" ":" DOUBLE<size>
                  (.
                     selector.style->SetSize(size);
                     selector.attributes.insert(ShieldStyle::attrSize);
                  .)
                | (. size_t priority; .)
                  "priority" ":" INTEGER<priority>
	              (.
	                if (priority>=0 && priority<std::numeric_limits<uint8_t>::max()) {
                     selector.style->SetPriority((uint8_t)priority);
                     selector.attributes.insert(ShieldStyle::attrPriority);
	                }
	                else {
	                  std::string e="Priority must be in the interval [0,"+
	                                NumberToString(std::numeric_limits<uint8_t>::max())+"[";

	                  SemErr(e.c_str());
	                }
	               .)
                )
                .

  PATHTEXTDEF<PathTextStyleSelector& selector>
              = (
                  (. PathTextStyle::Label label; .)
                  "label" ":" PATHTEXTLABEL<label>
                  (.
                     selector.style->SetLabel(label);
                     selector.attributes.insert(PathTextStyle::attrLabel);
                  .)
                | (. Color textColor; .)
                  "color" ":" COLOR<textColor>
                  (.
                     selector.style->SetTextColor(textColor);
                     selector.attributes.insert(PathTextStyle::attrTextColor);
                  .)
                | (. double size; .)
                  "size" ":" DOUBLE<size>
                  (.
                     selector.style->SetSize(size);
                     selector.attributes.insert(PathTextStyle::attrSize);
                  .)
                )
                .

  PATHSYMBOLDEF<PathSymbolStyleSelector& selector>
              = (
                  (.
                    std::string name;
                    SymbolRef   symbol;
                   .)
                  "symbol" ":" IDENT<name>
                  (.
                     symbol=config.GetSymbol(name);

                     if (symbol.Invalid()) {
                       std::string e="Map symbol '"+name+"' is not defined";

                       SemErr(e.c_str());
                     }
                     else {
                       selector.style->SetSymbol(symbol);
                       selector.attributes.insert(PathSymbolStyle::attrSymbol);
                     }
                  .)
                | (. double symbolSpace; .)
                  "symbolSpace" ":" DISPLAYSIZE<symbolSpace>
                  (.
                     selector.style->SetSymbolSpace(symbolSpace);
                     selector.attributes.insert(PathSymbolStyle::attrSymbolSpace);
                  .)
                )
                .

  ICONDEF<IconStyleSelector& selector>
              = (
                  (.
                    std::string name;
                    SymbolRef   symbol;
                   .)
                  "symbol" ":" IDENT<name>
                  (.
                     symbol=config.GetSymbol(name);

                     if (symbol.Invalid()) {
                       std::string e="Map symbol '"+name+"' is not defined";

                       SemErr(e.c_str());
                     }
                     else {
                       selector.style->SetSymbol(symbol);
                       selector.attributes.insert(IconStyle::attrSymbol);
                     }
                  .)
                | (. std::string name; .)
                  "name" ":" IDENT<name>
                  (.
                      selector.style->SetIconName(name);
                      selector.attributes.insert(IconStyle::attrIconName);
                  .)
                )
                .

  CAPSTYLE<LineStyle::CapStyle& style>
              = (
                  "butt"    (. style=LineStyle::capButt; .)
                | "round"   (. style=LineStyle::capRound; .)
                | "square"  (. style=LineStyle::capSquare; .)
                ).

  LABELSTYLE<TextStyle::Style& style>
              = (
                  "normal"    (. style=TextStyle::normal; .)
                | "emphasize" (. style=TextStyle::emphasize; .)
                ).

  TEXTLABEL<TextStyle::Label& label>
              = (
                  "name" (. label=TextStyle::name; .)
                | "ref"  (. label=TextStyle::ref; .)
                ).

  SHIELDLABEL<ShieldStyle::Label& label>
              = (
                  "name" (. label=ShieldStyle::name; .)
                | "ref"  (. label=ShieldStyle::ref; .)
                ).

  PATHTEXTLABEL<PathTextStyle::Label& label>
              = (
                  "name" (. label=PathTextStyle::name; .)
                | "ref"  (. label=PathTextStyle::ref; .)
                ).

  COLOR<Color& color>
              = color
                (.
                  if (strlen(t->val)==7 ||
                      strlen(t->val)==9) {
                    ToRGBA(t->val,color);
                  }
                  else {
                    color=Color();
                  }
                .).

  MAG<Mag& mag>
              =  "world"     (. mag=magWorld; .)
               | "continent" (. mag=magContinent; .)
               | "state"     (. mag=magState; .)
               | "stateOver" (. mag=magStateOver; .)
               | "county"    (. mag=magCounty; .)
               | "region"    (. mag=magRegion; .)
               | "proximity" (. mag=magProximity; .)
               | "cityOver"  (. mag=magCityOver; .)
               | "city"      (. mag=magCity; .)
               | "suburb"    (. mag=magSuburb; .)
               | "detail"    (. mag=magDetail; .)
               | "close"     (. mag=magClose; .)
               | "veryClose" (. mag=magVeryClose; .)
               | "block"     (. mag=magBlock; .)
               .

  /** Size in units of screen (currently millimeter) */
  DISPLAYSIZE <double& value>
              = DOUBLE<value> "mm".

  /** Size in units of map (currently meter) */
  MAPSIZE <double& value>
              = DOUBLE<value> "m".

  IDENT<std::string& value>
              = ident
                (.
                  value=t->val;
                .)
                .

  STRING<std::string& value>
              = string
                (.
                  value=Destring(t->val);
                .)
                .

  DOUBLE<double& value>
              = (  number
                  (.
                    if (!StringToDouble(t->val,value)) {
                      std::string e="Cannot parse double '"+std::string(t->val)+"'";

                      SemErr(e.c_str());
                    }
                  .)
                | double
                  (.
                    if (!StringToDouble(t->val,value)) {
                      std::string e="Cannot parse double '"+std::string(t->val)+"'";

                      SemErr(e.c_str());
                    }
                  .)
                ).

  INTEGER<size_t& value>
              = (  number
                  (.
                    if (!StringToNumber(t->val,value)) {
                      std::string e="Cannot parse number '"+std::string(t->val)+"'";

                      SemErr(e.c_str());
                    }
                  .)
                ).
END OSS.

